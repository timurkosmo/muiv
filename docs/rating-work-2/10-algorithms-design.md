# Проектирование алгоритмов

## 1. Алгоритм маршрутизации документов

**Назначение:** Определение пути движения документа между исполнителями

**Входные данные:**
- Идентификатор документа
- Тип документа
- Текущий этап обработки

**Алгоритм:**

```
1. Получить конфигурацию маршрута для типа документа из БД
2. Определить список этапов согласования
3. Идентифицировать текущий этап в последовательности
4. Проверить условия перехода к следующему этапу
   ЕСЛИ все согласования текущего этапа завершены:
5.     Определить следующий этап
6.     Идентифицировать список согласующих лиц по ролям
7.     ЕСЛИ этап поддерживает параллельное согласование:
8.         Создать задачи для всех согласующих одновременно
       ИНАЧЕ:
9.         Создать задачу для первого согласующего в списке
10.    Отправить уведомления назначенным исполнителям
11.    Обновить статус документа в БД
12.    Записать событие маршрутизации в журнал аудита
```

**Сложность:** O(n), где n - количество этапов в маршруте

**Оптимизация:**
- Кеширование конфигураций маршрутов в памяти
- Индексирование таблицы этапов по идентификатору маршрута

## 2. Алгоритм определения просроченных документов

**Назначение:** Выявление документов с истекшим или приближающимся сроком исполнения

**Входные данные:**
- Текущая дата
- Пороговое значение предупреждения (количество дней до срока)

**Алгоритм:**

```
1. Выбрать из БД все активные документы со статусом "в работе" или "на согласовании"
2. ДЛЯ КАЖДОГО документа:
3.     Сравнить установленный срок исполнения с текущей датой
4.     ЕСЛИ срок исполнения истек:
5.         Добавить документ в список просроченных
6.     ИНАЧЕ ЕСЛИ до срока исполнения осталось меньше порогового значения:
7.         Добавить документ в список требующих внимания
8. ДЛЯ КАЖДОГО просроченного документа:
9.     Определить ответственных исполнителей и их руководителей
10.    Сформировать уведомление о просрочке с количеством просроченных дней
11. ДЛЯ КАЖДОГО документа, требующего внимания:
12.    Сформировать напоминание исполнителям
13. Отправить сформированные уведомления и напоминания
14. Обновить статусы документов в БД (установить флаг просрочки)
15. Записать информацию о выявленных просрочках в журнал аудита
```

**Сложность:** O(m), где m - количество активных документов

**Оптимизация:**
- Индекс по полю срока исполнения
- Фильтрация на уровне БД
- Пакетная обработка уведомлений

## 3. Алгоритм полнотекстового поиска документов

**Назначение:** Поиск документов по ключевым словам и фильтрам

**Входные данные:**
- Поисковый запрос (строка)
- Список фильтров (тип документа, дата, автор, статус)

**Алгоритм:**

```
1. Разобрать поисковый запрос на отдельные термины (токенизация)
2. Нормализовать термины:
   - Привести к нижнему регистру
   - Удалить стоп-слова
   - Применить стемминг (получение основы слова)
3. Сформировать запрос к Elasticsearch с нормализованными терминами
4. Добавить к запросу фильтры по метаданным документов
5. Выполнить поисковый запрос
6. Получить список релевантных документов с рейтингами
7. Отсортировать результаты по релевантности с учетом дополнительных факторов:
   - Дата создания (более новые выше)
   - Популярность (частота обращений)
8. Применить постфильтрацию на основе прав доступа текущего пользователя
9. Выбрать метаданные найденных документов из основной БД
10. Сформировать превью содержимого с выделением найденных терминов
11. Вернуть результаты пользователю с разбивкой на страницы
```

**Сложность:** O(log n), где n - общее количество документов (благодаря инвертированному индексу Elasticsearch)

**Оптимизация:**
- Инвертированный индекс для мгновенного поиска терминов
- Кеширование результатов популярных запросов
- Fuzzy search для обработки опечаток
- Использование синонимов для расширения поиска
- Асинхронная индексация новых документов

## 4. Алгоритм генерации отчета по документообороту

**Назначение:** Формирование аналитического отчета на основе данных о документах

**Входные данные:**
- Период отчета (дата начала, дата окончания)
- Тип отчета
- Параметры группировки (по подразделениям, типам документов, исполнителям)

**Алгоритм:**

```
1. Валидировать входные параметры (корректность дат, допустимость типа отчета)
2. Сформировать SQL-запрос для агрегации данных из БД документов и журнала аудита
3. Применить фильтры по периоду и дополнительным критериям
4. Группировать данные согласно заданным параметрам
5. Вычислить агрегированные метрики:
   - Количество документов
   - Среднее время обработки
   - Доля просроченных документов
6. Выполнить запрос к БД, получить агрегированные данные
7. Постобработка данных для расчета производных показателей
8. Сформировать структуру отчета с заголовками и разделами
9. Заполнить таблицы отчета агрегированными данными
10. Сгенерировать визуализации (графики, диаграммы) на основе данных
11. Сформировать итоговый файл отчета в заданном формате (PDF, Excel)
12. Сохранить отчет в хранилище файлов
13. Вернуть ссылку на сгенерированный отчет пользователю
```

**Сложность:** O(d * log d), где d - количество документов за отчетный период (из-за сортировки при группировке)

**Оптимизация:**
- Материализованные представления для предварительной агрегации
- Индексы по полям группировки и фильтрации
- Кеширование результатов для идентичных запросов
- Параллельная генерация различных разделов отчета
- Асинхронная генерация с уведомлением по завершении

## Общие принципы оптимизации алгоритмов

1. **Использование индексов БД** для ускорения выборки данных
2. **Кеширование** часто запрашиваемых данных и результатов
3. **Пакетная обработка** для снижения количества обращений к БД
4. **Асинхронная обработка** для неблокирующего выполнения
5. **Параллелизация** независимых операций
